<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Security Demo Site — Security Log</title>
    <link rel="stylesheet" href="/css/style.css">

    <!-- Локальні стилі для картки і таблиці -->
    <style>
        main {
            max-width: 1500px;
            margin: 40px auto;
        }

        .admin-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .admin-card h1 {
            margin-top: 0;
        }

        .table-wrapper {
            margin-top: 20px;
            overflow-x: auto;
        }

        .admin-card table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
        }

        .admin-card th,
        .admin-card td {
            padding: 8px 10px;
            border: 1px solid #ccc; /* повернули контури */
        }
    </style>
</head>

<body>
<header>
    <img src="/img/logo.png" class="logo">
    <div class="title">Security Demo Site — Security Log</div>
    <nav>
        <a href="/">Головна</a>
        <a href="/login">Вхід</a>
        <a href="/register">Реєстрація</a>
        <a href="/profile">Кабінет</a>
        <a href="/auth/logout">Вихід</a>
        <a href="/admin">Адмін</a>
        <a href="/admin/analytics">Аналітика</a>
        <a href="/admin/events">Журнал подій</a>
    </nav>
</header>

<main>
    <div class="admin-card">
        <h1>Журнал інцидентів</h1>

        <div>
            <h3>Фільтр по IP:</h3>
            <input id="ip" placeholder="Наприклад 127.0.0.1">
            <button onclick="filterByIp()">Фільтрувати</button>

            <h3>Фільтр по правилу:</h3>
            <input id="rule" placeholder="Напр: SQLI, XSS, RATE_LIMIT">
            <button onclick="filterByRule()">Фільтрувати</button>

            <h3>Фільтр по даті:</h3>
            <input type="datetime-local" id="start">
            <input type="datetime-local" id="end">
            <button onclick="filterByDate()">Фільтрувати</button>

            <button onclick="loadAll()">Показати все</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>Дата</th>
                    <th>IP</th>
                    <th>Метод</th>
                    <th>URL</th>
                    <th>Правило</th>
                    <th>Ризик</th>
                    <th>Рішення</th>
                </tr>
                </thead>
                <tbody id="rows"></tbody>
            </table>
        </div>
    </div>
</main>

<script>
    // Форматування ISO-дати у щось читабельне типу "26.11.2025 20:00:04"
    function formatDate(isoString) {
        if (!isoString) return '';
        const d = new Date(isoString);
        if (isNaN(d.getTime())) return isoString; // fallback, якщо формат інший

        const pad = n => n.toString().padStart(2, '0');

        const day   = pad(d.getDate());
        const month = pad(d.getMonth() + 1);
        const year  = d.getFullYear();
        const hour  = pad(d.getHours());
        const min   = pad(d.getMinutes());
        const sec   = pad(d.getSeconds());

        return `${day}.${month}.${year} ${hour}:${min}:${sec}`;
    }

    // Просте екранування для запобігання XSS в журналі
    function esc(value) {
        if (value === null || value === undefined) return '';
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // Завантаження даних та побудова таблиці
    async function load(url) {
        try {
            const r = await fetch(url, { credentials: "include" });

            if (!r.ok) {
                console.error('Failed to load events:', r.status, await r.text());
                document.getElementById("rows").innerHTML =
                    `<tr><td colspan="7">Помилка завантаження (${r.status})</td></tr>`;
                return;
            }

            const data = await r.json();
            let html = "";

            for (const e of data) {
                const ip = (e.ip === '0:0:0:0:0:0:0:1') ? '127.0.0.1' : e.ip;

                html += `<tr>
                    <td>${esc(formatDate(e.timestamp))}</td>
                    <td>${esc(ip)}</td>
                    <td>${esc(e.method)}</td>
                    <td>${esc(e.path)}</td>
                    <td>${esc(e.ruleTrigger)}</td>
                    <td>${esc(e.riskScore)}</td>
                    <td>${esc(e.decision)}</td>
                </tr>`;
            }

            if (!data || data.length === 0) {
                html = `<tr><td colspan="7">Нічого не знайдено за вказаними фільтрами</td></tr>`;
            }

            document.getElementById("rows").innerHTML = html;
        } catch (e) {
            console.error('Error loading events:', e);
            document.getElementById("rows").innerHTML =
                `<tr><td colspan="7">Сталася помилка при завантаженні даних</td></tr>`;
        }
    }

    // Застосування всіх фільтрів разом (IP + правило + дата)
    function applyFilters() {
        const ip   = document.getElementById('ip').value.trim();
        const rule = document.getElementById('rule').value.trim();
        const s    = document.getElementById('start').value;
        const e    = document.getElementById('end').value;

        const params = new URLSearchParams();

        if (ip)   params.append('ip', ip);
        if (rule) params.append('rule', rule);
        if (s)    params.append('start', s);
        if (e)    params.append('end', e);

        const qs = params.toString();
        const url = '/api/admin/events/filter' + (qs ? '?' + qs : '');
        load(url);
    }

    // Скидання фільтрів і показ усіх подій
    function loadAll() {
        document.getElementById('ip').value = '';
        document.getElementById('rule').value = '';
        document.getElementById('start').value = '';
        document.getElementById('end').value = '';
        load('/api/admin/events');
    }

    // Старі функції-кнопки тепер просто викликають комбінований фільтр
    function filterByIp()   { applyFilters(); }
    function filterByRule() { applyFilters(); }
    function filterByDate() { applyFilters(); }

    // Перше завантаження — показати всі події
    loadAll();
</script>


</body>
</html>
